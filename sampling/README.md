# Metropolis Algorithmの概要

## マルコフ連鎖
### 2状態の例
状態A,B、遷移確率行列Tがあったとする。
$(A_{t-1} B_{t-1}) = T (A_t B_t)$
と遷移していくモデルが作れる。

定常状態として、Tの固有値1に対応する固有ベクトル
$(A_\infty B_\infty)$
がある。これは
$(A B) = T (A B)$
を満たす。

### 一般に拡張
状態の集合をSとして、$x, y\in S$について遷移確率$\pi(x \to y)$を考える。
またその状態にいる確率を$P(x)$とする。

マルコフ連鎖だから、
$P_{t+1}(y) = \sum_x P_t (x) \pi(x\to y)$ が$\forall t, y$で成り立つはず。

### 釣り合い・安定釣り合い

定常状態での確率分布$P(x)$があるとすると、それは釣り合いの式(各状態について、総和の一定)
$$P(y) = \sum_x P(x) \pi(x\to y)$$
を満たすはず。

上の十分条件として、詳細釣り合いの式(より強い条件で、全状態ペアについて、総和の一定)
$$P(x)\pi(x\to y) = P(y)\pi(y \to x)$$
が考えられる。(詳細釣り合いならば、上の釣り合い)


## メトロポリス法による遷移確率
$P(x)$があった時に、逆にこれを定常分布に持つようなマルコフ連鎖の遷移確率行列$\pi$を求めたい。(そうすると、$\pi$を使った$P_t(x)$の$t$に関するiterationで、$P(x)$のサンプリングができる。)
詳細釣り合いの式から、それを満たす$\pi$は無限個あるが、その1つの決め方がメトロポリスアルゴリズム。
$\pi(x\to y) = T(y|x) \min \left\{ 1, \frac{p(y)}{p(x)} \right\}$として作る。前は$y$が候補に上がる確率(提案分布$T$が使われる)で、後ろはその$y$が採択される確率、というパーツに分かれている。

これが上の詳細釣り合いの式を満たすのを示せば良い。
$p(x) > p(y)$を仮定して、
$P(x)\pi(x\to y) = p(x) T(y|x) \frac{p(y)}{p(x)}$
$P(y)\pi(y \to x) = p(y) T(x|y) 1$
今$T(y|x) = T(x|y)$なる分布を使っているとすると、二式は等号で結ばれるから、証明できた。

確率を、大きい方を1ととったと考えても良い。



## アルゴリズム化
これをコードに起こすと、次のようになる。
```
y(k) ~ T(y(k) | x(k))   yをxを中心とした正規分布からとってくる
r ~ [0,1)  あとで使う 一様分布からの乱数

x(k+1) 
  = y(k) ( if q(y(k))/q(x(k)) > r  )
or
  = x(k) ( else )
```

採択の部分で、$\frac{p(y)}{p(x)} > r$とは、$\frac{p(y)}{p(x)} = p$とおくと、$0\leq p \leq 1$であれば、$x ~ [0,1)$で$0\leq x \leq p$となる確率は$p$であることから、上の条件を言い換えたものだとわかる。(例えばxを0.1刻みで10回サンプリングした時を考えると、$r=0.3$の時は10回中3回は条件を満たす、つまり確率は0.3)

## references
計算統計2 マルコフ連鎖モンテカルロ法とその周辺 伊庭etal
https://www.slideshare.net/teramonagi/ss-5190440
http://www-fcs.acs.i.kyoto-u.ac.jp/~harada/OC/section_mcmc.html
http://webpark1956.sakura.ne.jp/WS/huku-tutorial.pdf
